<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>INOVA BLE → Sheets (Multi-dispositivo)</title>
<style>
  :root { color-scheme: light dark; }
  body { font-family: Arial, sans-serif; padding:16px; line-height:1.45; }
  h1 { margin:0 0 10px; font-size:20px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input[type="text"], select { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
  .row { display:grid; grid-template-columns:1fr; gap:10px; }
  @media (min-width:900px){ .row{ grid-template-columns:1fr 1fr; } }
  button { padding:10px 14px; font-size:15px; border-radius:10px; border:0; cursor:pointer; margin-right:8px; margin-top:8px; }
  #btnConnect { background:#0a7; color:#fff; }
  #btnDisconnect { background:#c33; color:#fff; }
  #btnDisconnectAll { background:#555; color:#fff; }
  #btnSendCmd { background:#1464f4; color:#fff; }
  .sec { margin-top:14px; }
  .log { white-space:pre-wrap; background:#f8f8f8; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:14px; max-height:55vh; overflow:auto; }
  .ok{color:#0a8;} .warn{color:#c80;} .err{color:#c00;} .muted{color:#666;font-size:12px;}
  .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#eef; margin-left:6px; font-size:12px; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:680px){ .grid2{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<h1>INOVA BLE → Google Sheets <span id="pageBadge" class="badge"></span></h1>
<p class="muted">Multi-dispositivo: conecte vários Sylvac ao mesmo tempo. Selecione o ativo para enviar comandos.</p>

<div class="row">
  <div>
    <label>GAS_ENDPOINT</label>
    <input id="endpoint" type="text"
      value="https://script.google.com/macros/s/AKfycbwn8jFg3x0CWlLqTOVhT7LJ2XTNdL0d9VEllL8qN3W-RFIFFMZaaxRc3MJiGm01Fxha/exec">
  </div>
  <div>
    <label>Service UUID (Sylvac – medição)</label>
    <input id="svc" type="text" value="c1b25000-caaf-6d0e-4c33-7dae30052840">
  </div>
  <div>
    <label><input type="checkbox" id="battery" checked> Ler nível de bateria (0x180F/0x2A19)</label>
    <div class="muted">Mantenha o instrumento “acordado”.</div>
  </div>
  <div>
    <label><input type="checkbox" id="keepalive" checked> Keep-alive (2s)</label>
    <label><input type="checkbox" id="autorec" checked> Auto-reconnect</label>
  </div>
</div>

<div class="sec">
  <button id="btnConnect">+ Adicionar conexão</button>
  <select id="selActive" title="Conectados" style="min-width:280px"></select>
  <button id="btnDisconnect">Desconectar selecionado</button>
  <button id="btnDisconnectAll">Desconectar TODOS</button>
</div>

<div class="sec grid2">
  <div>
    <label>Alias do instrumento</label>
    <div class="grid2">
      <input id="aliasInput" type="text" placeholder="Ex.: OP10_Paq01">
      <button id="btnSaveAlias">Salvar alias</button>
    </div>
    <div class="muted">Alias salvo por ID estável (serial/systemId/pnpId) no navegador e enviado à planilha.</div>
  </div>
  <div>
    <label>Comandos ASCII (RemoteReq → RemoteResp)</label>
    <div class="grid2">
      <input id="cmdInput" type="text" placeholder='Ex.: VER?  (ENTER envia). Sufixo "\r" é adicionado.' />
      <select id="cmdPreset">
        <option value="">— Atalhos —</option>
        <option value="r">r  (Requisitar leitura)</option>
        <option value="VER?">VER?  (Versão)</option>
        <option value="ID?">ID?  (Identificação)</option>
        <option value="SN?">SN?  (Serial)</option>
        <option value="UNIT?">UNIT?  (Unidade)</option>
        <option value="TOL?">TOL?  (Tolerância)</option>
      </select>
    </div>
    <button id="btnSendCmd">Enviar comando</button>
  </div>
</div>

<div class="log" id="log"></div>

<script>
/* ===== Infra de sessões (multi-dispositivo) ===== */
const sessions = new Map();  // key = chrome device.id -> Session
const selActive = document.getElementById('selActive');

class Session {
  constructor(device){ this.device=device; this.server=null; this.svc=null;
    this.cDataSend=null; this.cRemoteResp=null; this.cRemoteReq=null;
    this.label=device.name||''; this.model=''; this.serial=''; this.systemId=''; this.pnpId='';
    this.stableId=''; this.alias=''; this.battery=''; this.keepTimer=null; this.reconnecting=false; }
}
function active(){ const id=selActive.value; return id? sessions.get(id):null; }
function addSelectOption(sess){
  const o=document.createElement('option');
  o.value=sess.device.id;
  o.textContent=`${sess.label||'(sem nome)'} · ${sess.device.id}`;
  selActive.appendChild(o);
  selActive.value=sess.device.id;
}
function refreshSelectLabel(sess){
  const opt=[...selActive.options].find(o=>o.value===sess.device.id);
  if(opt) opt.textContent = `${sess.label||'(sem nome)'} · ${sess.device.id}`;
}

/* ===== Util ===== */
const logEl=document.getElementById('log'), pageBadge=document.getElementById('pageBadge');
function log(msg, cls=''){ const d=document.createElement('div'); d.textContent=msg; if(cls) d.className=cls; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function hex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(' '); }
function setPageBadge(){ pageBadge.textContent = `Conexões: ${sessions.size}`; }

/* ===== Decoder Sylvac ===== */
function decodeSylvac(dv){
  const u8=new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
  const printable = u8.filter(b => b>=0x20 && b<=0x7E);
  const txt = new TextDecoder().decode(printable).trim();
  let value=NaN, unit='mm', status='OK';
  const m = txt.match(/[-+]?\d+(?:[.,]\d+)?/); if(m) value=parseFloat(m[0].replace(',','.'));
  if (txt.includes('<')||txt.includes('>')) status='NG';
  return { value, unit, status, rawText: txt };
}

/* ===== GAS ===== */
async function postToSheets(payload){
  const endpoint=document.getElementById('endpoint').value.trim();
  if(!endpoint) return;
  try{
    await fetch(endpoint,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  }catch(e){ log('Falha ao enviar ao GAS: '+e, 'warn'); }
}

/* ===== DIS & ID estável ===== */
async function readDIS(sess){
  try{
    const dis = await sess.server.getPrimaryService('device_information');
    async function readStr(uuid){ try{ const c=await dis.getCharacteristic(uuid); const v=await c.readValue(); return new TextDecoder().decode(v).trim(); }catch{return '';} }
    async function readBin(uuid){ try{ const c=await dis.getCharacteristic(uuid); const v=await c.readValue(); return Array.from(new Uint8Array(v.buffer)).map(b=>b.toString(16).padStart(2,'0')).join(':'); }catch{return '';} }

    sess.serial   = await readStr('serial_number_string');      // 0x2A25
    sess.model    = await readStr('model_number_string');       // 0x2A24
    const fw      = await readStr('firmware_revision_string');  // 0x2A26
    sess.systemId = await readBin('system_id');                 // 0x2A23
    sess.pnpId    = await readBin('pnp_id');                    // 0x2A50

    sess.label = (sess.model?('MODEL '+sess.model):sess.label) + (sess.serial?(' / S/N '+sess.serial):'');
    sess.stableId = sess.serial ? ('SN:'+sess.serial)
                    : (sess.systemId?('SYSID:'+sess.systemId)
                    : (sess.pnpId?('PNP:'+sess.pnpId)
                    : ('MODEL:'+ (sess.model||'') +'#'+ (fw||'') +'#'+ sess.device.id)));
    refreshSelectLabel(sess);
    setPageBadge();

    // Alias armazenado
    const map = JSON.parse(localStorage.getItem('inova_ble_alias')||'{}');
    sess.alias = map[sess.stableId] || '';
    if(active()===sess) document.getElementById('aliasInput').value=sess.alias;

    log(`DIS(${sess.device.id}): model=${sess.model||'-'} serial=${sess.serial||'-'} sysId=${sess.systemId||'-'} pnpId=${sess.pnpId||'-'}`, 'muted');
  }catch{ log('DIS não disponível (seguindo).','warn'); }
}

/* ===== CCCD helper ===== */
async function enableCCCD(ch, val){
  try{
    const d = await ch.getDescriptor('00002902-0000-1000-8000-00805f9b34fb');
    await d.writeValue(Uint8Array.of(val,0x00));
  }catch{}
}

/* ===== Setup serviço e callbacks ===== */
async function setupSylvac(sess, SVC){
  sess.svc = await sess.server.getPrimaryService(SVC);
  const chars = await sess.svc.getCharacteristics();
  sess.cDataSend=null; sess.cRemoteResp=null; sess.cRemoteReq=null;

  for (const c of chars){
    const p=c.properties||{};
    if(!sess.cDataSend && p.indicate) sess.cDataSend=c;
    if(!sess.cRemoteResp && p.notify) sess.cRemoteResp=c;
    if(!sess.cRemoteReq && (p.writeWithoutResponse||p.write)) sess.cRemoteReq=c;
  }
  if(sess.cDataSend){
    await sess.cDataSend.startNotifications();
    await enableCCCD(sess.cDataSend, 0x02);
    sess.cDataSend.addEventListener('characteristicvaluechanged', ev=>{
      const dv=ev.target.value, parsed=decodeSylvac(dv);
      log(`DataSend[${sess.device.id}] "${parsed.rawText}"`, 'muted');
      if(!Number.isNaN(parsed.value)){
        const payload={
          deviceName: sess.label, stableId: sess.stableId, alias: sess.alias,
          chromeDeviceId: sess.device.id, model: sess.model, serial: sess.serial,
          systemId: sess.systemId, pnpId: sess.pnpId,
          value: parsed.value, unit: parsed.unit, status: parsed.status,
          battery: sess.battery, rawHex: hex(new Uint8Array(dv.buffer))
        };
        log('Leitura → '+JSON.stringify(payload),'ok');
        postToSheets(payload);
      }
    });
    log('DataSend (INDICATE) assinada.','ok');
  } else log('DataSend não encontrada.','warn');

  if(sess.cRemoteResp){
    await sess.cRemoteResp.startNotifications();
    await enableCCCD(sess.cRemoteResp, 0x01);
    sess.cRemoteResp.addEventListener('characteristicvaluechanged', ev=>{
      const parsed=decodeSylvac(ev.target.value);
      log(`RemoteResp[${sess.device.id}] "${parsed.rawText}"`, 'muted');
    });
    log('RemoteResp (NOTIFY) assinada.','ok');
  }
  if(sess.cRemoteReq) log('RemoteReq (WRITE) disponível.','ok'); else log('RemoteReq não encontrada.','warn');
}

/* ===== Keep-alive ===== */
function startKeepAlive(sess){
  clearInterval(sess.keepTimer);
  if(!document.getElementById('keepalive').checked) return;
  sess.keepTimer=setInterval(async()=>{
    try{
      if(sess.server?.connected && sess.cRemoteReq){
        await sess.cRemoteReq.writeValueWithoutResponse(Uint8Array.of(0x01));
      }
    }catch{}
  },2000);
}

/* ===== Conexão ===== */
async function connectDevice(){
  try{
    const SVC=document.getElementById('svc').value.trim();
    const dev = await navigator.bluetooth.requestDevice({
      acceptAllDevices:true,
      optionalServices:[SVC,'battery_service','device_information']
    });
    if(!dev) return;

    const sess=new Session(dev);
    sessions.set(dev.id, sess);
    addSelectOption(sess); setPageBadge();
    log(`Selecionado: ${dev.name||'(sem nome)'} — ID ${dev.id}`);

    sess.server = await dev.gatt.connect();

    if (document.getElementById('battery').checked) {
      try{
        const bs=await sess.server.getPrimaryService('battery_service');
        const bc=await bs.getCharacteristic('battery_level');
        sess.battery=(await bc.readValue()).getUint8(0);
        log(`Bateria[${dev.id}]: ${sess.battery}%`,'ok');
      }catch{ log('Battery service indisponível.','warn'); }
    }

    await readDIS(sess);
    await setupSylvac(sess, SVC);
    startKeepAlive(sess);

    dev.addEventListener('gattserverdisconnected', async ()=>{
      log(`Desconectado: ${dev.id}`,'warn');
      clearInterval(sess.keepTimer);
      if(document.getElementById('autorec').checked && !sess.reconnecting){
        sess.reconnecting=true;
        try{
          await dev.gatt.connect(); sess.reconnecting=false;
          log(`Reconectado: ${dev.id}`,'ok');
          await setupSylvac(sess,SVC); startKeepAlive(sess);
        }catch{ sess.reconnecting=false; }
      }
    });
  }catch(e){ log('Erro: '+e,'err'); }
}

/* ===== Desconectar ===== */
function disconnectSelected(){
  const s=active(); if(!s) { log('Nada selecionado.','warn'); return; }
  try{
    clearInterval(s.keepTimer);
    if(s.server?.connected) s.device.gatt.disconnect();
    sessions.delete(s.device.id);
    const idx=selActive.selectedIndex;
    selActive.remove(idx);
    setPageBadge();
    log(`Encerrado: ${s.device.id}`,'warn');
  }catch(e){ log('Falha ao desconectar: '+e,'err'); }
}
function disconnectAll(){
  for(const s of sessions.values()){
    try{ clearInterval(s.keepTimer); if(s.server?.connected) s.device.gatt.disconnect(); }catch{}
  }
  sessions.clear();
  selActive.innerHTML='';
  setPageBadge();
  log('Todos desconectados.','ok');
}

/* ===== Comandos / Alias ===== */
function sendAscii(){
  const s=active(); if(!s){ log('Selecione um dispositivo.','warn'); return; }
  if(!s.cRemoteReq){ log('WRITE não disponível.','err'); return; }
  let txt=document.getElementById('cmdInput').value.trim();
  if(!txt) return; if(!txt.endsWith('\r')) txt+='\r';
  s.cRemoteReq.writeValueWithoutResponse(new TextEncoder().encode(txt)).then(()=>{
    log(`ASCII[${s.device.id}] → ${JSON.stringify(txt)}`);
  }).catch(e=>log('Falha cmd: '+e,'err'));
}
function saveAlias(){
  const s=active(); if(!s) return;
  const a=document.getElementById('aliasInput').value.trim();
  s.alias=a;
  const map=JSON.parse(localStorage.getItem('inova_ble_alias')||'{}'); map[s.stableId]=a;
  localStorage.setItem('inova_ble_alias', JSON.stringify(map));
  log(`Alias salvo (${s.stableId}) → "${a||'(vazio)'}"`, 'ok');
}

/* ===== UI bindings ===== */
document.getElementById('btnConnect').addEventListener('click', connectDevice);
document.getElementById('btnDisconnect').addEventListener('click', disconnectSelected);
document.getElementById('btnDisconnectAll').addEventListener('click', disconnectAll);

document.getElementById('btnSendCmd').addEventListener('click', sendAscii);
document.getElementById('cmdInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendAscii(); }});
document.getElementById('cmdPreset').addEventListener('change', e=>{
  const v=e.target.value; if(!v) return; document.getElementById('cmdInput').value=v; sendAscii(); e.target.selectedIndex=0;
});

document.getElementById('btnSaveAlias').addEventListener('click', saveAlias);
selActive.addEventListener('change', ()=>{
  const s=active(); if(!s) return;
  document.getElementById('aliasInput').value = s.alias||'';
});

setPageBadge();
</script>
</body>
</html>
