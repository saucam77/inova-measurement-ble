<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BLE GATT → Google Sheets (MVP Sylvac)</title>
<style>
  :root { color-scheme: light dark; }
  body { font-family: Arial, sans-serif; padding:16px; line-height:1.45; }
  h1 { margin:0 0 10px; font-size:20px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input[type="text"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
  .row { display:grid; grid-template-columns:1fr; gap:10px; }
  @media (min-width:720px){ .row{ grid-template-columns:1fr 1fr; } }
  button { padding:10px 14px; font-size:15px; border-radius:10px; border:0; cursor:pointer; margin-right:8px; margin-top:8px; }
  #btnConnect { background:#0a7; color:#fff; }
  #btnDisconnect { background:#c33; color:#fff; }
  .sec { margin-top:14px; }
  .log { white-space:pre-wrap; background:#f8f8f8; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:14px; max-height:55vh; overflow:auto; }
  .ok{color:#0a8;} .warn{color:#c80;} .err{color:#c00;} .muted{color:#666;font-size:12px;}
</style>
</head>
<body>
<h1>BLE GATT → Google Sheets (MVP)</h1>
<p class="muted">Sylvac via Web Bluetooth (Android/Chrome). Após conectar, use um dos botões de comando ou o botão do instrumento.</p>

<div class="row">
  <div>
    <label>GAS_ENDPOINT (Apps Script)</label>
    <input type="text" id="endpoint"
      value="https://script.google.com/macros/s/AKfycbwn8jFg3x0CWlLqTOVhT7LJ2XTNdL0d9VEllL8qN3W-RFIFFMZaaxRc3MJiGm01Fxha/exec">
  </div>
  <div>
    <label>Service UUID (medição)</label>
    <input type="text" id="svc" value="c1b25000-caaf-6d0e-4c33-7dae30052840">
  </div>
  <div>
    <label>Characteristic UUID (NOTIFY)</label>
    <input type="text" id="chrNotify" value="c1b25013-caaf-6d0e-4c33-7dae30052840">
  </div>
  <div>
    <label>Characteristic UUID (INDICATE)</label>
    <input type="text" id="chrIndicate" value="c1b25010-caaf-6d0e-4c33-7dae30052840">
  </div>
  <div>
    <label>Characteristic UUID (WRITE)</label>
    <input type="text" id="chrWrite" value="c1b25012-caaf-6d0e-4c33-7dae30052840">
  </div>
  <div>
    <label><input type="checkbox" id="battery" checked> Ler nível de bateria (0x180F/0x2A19)</label>
    <div class="muted">Dica: mantenha o instrumento “acordado” (aperte o botão) antes de conectar.</div>
  </div>
</div>

<div class="sec">
  <button id="btnConnect">Conectar & Assinar</button>
  <button id="btnDisconnect">Desconectar</button>
  <button id="btnReq01">Pedir leitura (0x01)</button>
  <button id="btnReqR">Pedir leitura ("r")</button>
  <button id="btnStart">Start contínuo (0x02)</button>
  <button id="btnStop">Stop (0x03)</button>
</div>

<div class="log" id="log"></div>

<script>
let g = { device:null, server:null, svc:null, cNotify:null, cIndicate:null, cWrite:null, battery:'' };

const logEl = document.getElementById('log');
function log(msg, cls=''){ const d=document.createElement('div'); d.textContent=msg; if(cls) d.className=cls; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function toHex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(' '); }

// === Parser Sylvac: "0000.001 <" → value=0.001, unit=mm, status=NG ===
function decodeValue(dv){
  const u8=new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
  const txt=new TextDecoder('utf-8').decode(u8).trim();
  const clean=txt.replace(/[\r\n]/g,'').trim();

  let value=NaN, unit='mm', status='OK';
  const m=clean.match(/(-?\d+[.,]?\d*)/);
  if(m) value = parseFloat(m[1].replace(',', '.'));
  if (clean.includes('<') || clean.includes('>')) status='NG';

  return { value, unit, status, rawText: clean };
}

async function postToSheets(endpoint, payload){
  try{
    await fetch(endpoint,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  }catch(e){ log('Falha ao enviar ao GAS: '+e,'warn'); }
}

function onValue(ev){
  const dv=ev.target.value;
  const parsed=decodeValue(dv);
  const rawHex=toHex(new Uint8Array(dv.buffer));
  const payload={ deviceName:g.device?.name||'', deviceId:g.device?.id||'', value:parsed.value, unit:parsed.unit, status:parsed.status, battery:g.battery, rawHex };
  log('Leitura: '+JSON.stringify(payload),'ok');
  const endpoint=document.getElementById('endpoint').value.trim();
  if(endpoint) postToSheets(endpoint,payload);
}

async function connectAndSubscribe(){
  try{
    const SVC=document.getElementById('svc').value.trim();
    const CHR_NOTIFY=document.getElementById('chrNotify').value.trim();
    const CHR_INDIC=document.getElementById('chrIndicate').value.trim();
    const CHR_WRITE=document.getElementById('chrWrite').value.trim();
    const READ_BATT=document.getElementById('battery').checked;

    if(!navigator.bluetooth){ log('Web Bluetooth não suportado (use Chrome no Android).','err'); return; }

    // Descoberta: tenta por prefixo 'SY' e fallback acceptAllDevices
    const REQS=[
      { filters:[{namePrefix:'SY'}], optionalServices:[SVC,'battery_service','device_information'] },
      { acceptAllDevices:true, optionalServices:[SVC,'battery_service','device_information'] }
    ];
    let device=null;
    for(const opt of REQS){
      try{ log('Procurando dispositivo BLE…'); device=await navigator.bluetooth.requestDevice(opt); if(device) break; }
      catch{ log('Tentativa de descoberta falhou; tentando outra…','warn'); }
    }
    if(!device) throw new Error('Não foi possível selecionar o dispositivo.');

    g.device=device; log(`Selecionado: ${device.name||'(sem nome)'} — ID: ${device.id}`);

    g.server=await device.gatt.connect();

    // Bateria (opcional)
    g.battery='';
    if(READ_BATT){
      try{
        const bs=await g.server.getPrimaryService('battery_service');
        const bc=await bs.getCharacteristic('battery_level');
        g.battery=(await bc.readValue()).getUint8(0);
        log(`Bateria: ${g.battery}%`,'ok');
      }catch{ log('Battery service indisponível.','warn'); }
    }

    g.svc=await g.server.getPrimaryService(SVC);

    // NOTIFY
    try{
      g.cNotify=await g.svc.getCharacteristic(CHR_NOTIFY);
      await g.cNotify.startNotifications();
      g.cNotify.addEventListener('characteristicvaluechanged', onValue);
      log('NOTIFY assinada. Gere uma medida…','ok');
    }catch{ log('Characteristic NOTIFY não disponível.','warn'); }

    // INDICATE
    try{
      g.cIndicate=await g.svc.getCharacteristic(CHR_INDIC);
      await g.cIndicate.startNotifications(); // Web Bluetooth trata indicate via notifications API
      g.cIndicate.addEventListener('characteristicvaluechanged', onValue);
      log('INDICATE assinada.','ok');
    }catch{ log('Characteristic INDICATE não disponível.','warn'); }

    // WRITE
    try{
      g.cWrite=await g.svc.getCharacteristic(CHR_WRITE);
      log('Canal de WRITE pronto.','ok');
    }catch{ log('Characteristic WRITE não disponível.','warn'); }

    g.device.addEventListener('gattserverdisconnected', ()=>log('Desconectado.','warn'));
  }catch(e){ log('Erro: '+e,'err'); }
}

function disconnectNow(){
  try{
    if(g?.device?.gatt?.connected){ g.device.gatt.disconnect(); }
    g = { device:null, server:null, svc:null, cNotify:null, cIndicate:null, cWrite:null, battery:'' };
    log('Conexão encerrada.','warn');
  }catch(e){ log('Falha ao desconectar: '+e,'err'); }
}

async function writeCmd(bytes){
  if(!g.cWrite){ log('WRITE não disponível.','err'); return; }
  try{
    await g.cWrite.writeValueWithoutResponse(new Uint8Array(bytes));
    log('Comando enviado: '+bytes.map(b=>'0x'+b.toString(16).padStart(2,'0')).join(' '));
  }catch(e){ log('Falha ao enviar comando: '+e,'err'); }
}

// UI
document.getElementById('btnConnect').addEventListener('click', connectAndSubscribe);
document.getElementById('btnDisconnect').addEventListener('click', disconnectNow);
document.getElementById('btnReq01').addEventListener('click', ()=>writeCmd([0x01])); // hipótese comum
document.getElementById('btnReqR').addEventListener('click', ()=>writeCmd([0x72]));  // 'r'
document.getElementById('btnStart').addEventListener('click', ()=>writeCmd([0x02])); // start (se suportado)
document.getElementById('btnStop').addEventListener('click', ()=>writeCmd([0x03]));  // stop (se suportado)
</script>
</body>
</html>
